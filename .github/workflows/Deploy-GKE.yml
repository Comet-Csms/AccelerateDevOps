name: Deploy-GKE

on: [workflow_dispatch]

env:
  GKE_PROJECT: aiosshsj
  GKE_CLUSTER: hsj-demo-cluster
  GKE_APP_NAME: hsj-demo-shop
  GKE_SERVICE: hsj-service
  GKE_SERVICE_ACCOUNT: hsj-serviceaccount
  GKE_DEPLOYMENT_NAME: hsj-demo-shop-deployment
  GKE_REGION: asia-northeast3
  GKE_ZONE: asia-northeast3-a
  
jobs:
  Build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # Setup gcloud CLI
    - uses: google-github-actions/setup-gcloud@v2.1.0
      with:
        service_account_key: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAibGlxdWlkLXBvbHlnb24tNDA0NjAwIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMmY0YjVkMDU4ZmM2MDJiODY1NWM2MzVmOWNmOThmMGQwYTQ5NWJmNCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZBSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS1l3Z2dTaUFnRUFBb0lCQVFDWXk1NWZxQVR1R1RseVxuRUtCdGp0Qk5PUFhRaTBTQTRjVCtGTmZYQ2FlSEdrdFYxRE9vWFdkcDhOMGQ5dlBiem9rWEIvSjl1SWdWMnFJclxudGJlYnZJaUdaUkpid3IrVzVuOXQyUUQ3MnpOSXVZZkd2d0xSMm1CK0Z2ZGU5c2VHc2xOdUg2MklUOWx1UExBSVxuYVgxNE11WDlmOG83WUMxQmx5Z3Y0dnlBanRWME1VMWNXWHIxREZNVkJoL2pzRHlaYytGUW5RbFp2TkVYenQ4Y1xuTjB0VXFBRzVDWVEwTGlqOHVSUndmUEMzYzF6b3NPVUlialNrSG1oNk90WUJBOS9vd2xsenZNN2R6TXBLUVZUcVxuRzErNEdZTmRGcUtnQXNFQWtiQThFQzVDL2JwSXpqSng1T1dBakpsMlE2ZmlLbHJRemRFWGVBbEdLSm5YVmprL1xuR2d6K0VIM3RBZ01CQUFFQ2dmOHhTaWppTXJ3UEV1bGZ6U2Z6aFFrdE5YTEJhTlp3WjdtNTU5UzQ5SG1yMjQrY1xuaXhmSm93S2o2azlxUmRVNktIdVEzUlRIVHYvc3Q0VnVhWnNSWWlyOTJuSlJwNWFtZ2Q5dSt0SHJ3b3FJcTFFTVxuTnJ6SGRaV0FiTDJLcE9hTjk4NGN6WnRDbmRUdytzMTVQbzU3SXBya0ZwVTd2T0F4M2RFdVRDQlRBeFlEVDdtMFxuZ3JoT1FRUXVrdVhKc2l3OS9CUGs5Uk9obGFSQzY2cWFobTNjUjE0cFRpRFRTR1FrSnZvVmpUbXNxQWxKTFRuRVxuNFlrZjlxUEFuNFg5Y0c4ZStpOGpJYUVRMTB2NEZQUHVqdkxyd3NvdHJxeGo4c1ZFazRpWlNGMjlnRmtnTGF3Q1xuUVBLTTF5QnhnemFSRnJqSGJUNmxVbEJkMU5TeG9qTjdKYTE2UXNrQ2dZRUEwcWZEL1RyVld0SWlwemZ1SUdlVVxuK09wc2ZESGI4L1YxQWNiUWN6bUdycDgxWlhxaCtSOG1KcjBhOWEyZ3VkSU9QUFhGclFzN0VXOS9UcGkyK0xZblxuelJ4V1RmSDNaZlZKeWdhWXNXaUE2VDNjT3ovZHpuK3FFV0dnOFFOcWNyaUFPV2tkMkRoUWl3Ni9oZzRlNmFDNVxub25NRFR3WTVoREFJRlZUZEFYSU1hT2tDZ1lFQXVhOTE4dzlJMUV0a1l5UmRPaGdSRUk1aE5Ncmw5YUxOMFdBc1xubnBpTVZxVUx5NmYvd3hhSGRGUjlMYjZBR0VubUN5MzM3SldJWFZqM0h6WEk0RXRyWExhRTcyUEo3MklBVHl4U1xudm1RZzNIRHlBL1FMcGlUbUsxc2lHOXAyMlIrWHRNWFgrb1FNZmllSlZIajBFc3JmSnUwWkphV0ZsOFZobFBiWlxublY5Q0NtVUNnWUF0c3Brd3NQZWh1UjR0V2xPOUVkdGVXRFJxaU1KblhPTWlISWdSeHZQeG83WUlxcDdDbFVCSVxuZlJPQklrWlFxVUhQZFoySldYdFozKzhsRkxuMG9FZG9GbktlZkJRb09Scmx5YUtNTWRodFFLOHE1MEx0emdJTlxudlRrVnI2RUMvQVZNN3dHN2F4UUY1cEFqdTZKM0doZkxKdG9iNVlUS3FVVEhvOTVCdHdUOEtRS0JnUUM1SXIrSVxuWTRIcTRXeXJDUFBHMjM0UU10V3FyRzVSMWt3OTZSVXozOGQxRUVSTmZ5aWNHOWRjWG0wYzhlYUgwUTZEc1FhVFxucFpmNzhwc2FUQ2NIczByTmV0SGFXWFZhcnl5OXcrU1FIZ2RCbzM4NS85YXBoZnJUMlo2TmhPbWduRVpISUVleVxuYUh5SVArVkdDdjdYeWR4cTFGV1JXcEp6ZTRKSzQwQ2dEdjBxblFLQmdRQzFLeTh0OGZYWnFYVDhQNkNFRW1selxuR2E5S3k2Qm5rYXNmT1pQdHVmWTBwQzB0RDU2Ukx4MW9zSGQxb096elF6VlplaHBSTVdNYjM4WTduejhXMkd4ZVxudUc5cytrNTArM1JpNURXZXpIU1pvd0VNZzZGcXUrWEhiNGNYMFFacEpCRjNta2lKRDJISEQ3M3NuVzFNeFhydFxuM290eXJXTGZHYjRsUUhUcnE5eVFpZz09XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiaHNqLXNlcnZpY2VhY2NvdW50QGxpcXVpZC1wb2x5Z29uLTQwNDYwMC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMTQ4ODk3OTI2MDkyMDUzNjM4NjQiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2hzai1zZXJ2aWNlYWNjb3VudCU0MGxpcXVpZC1wb2x5Z29uLTQwNDYwMC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSIKfQo=
        project_id: aiosshsj
        export_default_credentials: true 

    # Build the Docker image
    - name: Build and Push
      working-directory: ch9_release/src/Tailwind.Traders.Web
      run: |-  
        docker build \
          --tag "$GKE_REGION-docker.pkg.dev/$GKE_PROJECT/$GKE_PROJECT/$GKE_APP_NAME:$GITHUB_SHA" \
          --build-arg GITHUB_SHA="$GITHUB_SHA" \
          --build-arg GITHUB_REF="$GITHUB_REF" \
          .
        gcloud auth configure-docker $GKE_REGION-docker.pkg.dev --quiet
        docker push "$GKE_REGION-docker.pkg.dev/$GKE_PROJECT/$GKE_PROJECT/$GKE_APP_NAME:$GITHUB_SHA"     

  Deploy:
    runs-on: ubuntu-latest
    environment: prod
    needs: Build

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # Setup gcloud CLI
    - uses: google-github-actions/setup-gcloud@v2.1.0
      with:
        service_account_key: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAibGlxdWlkLXBvbHlnb24tNDA0NjAwIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMmY0YjVkMDU4ZmM2MDJiODY1NWM2MzVmOWNmOThmMGQwYTQ5NWJmNCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZBSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS1l3Z2dTaUFnRUFBb0lCQVFDWXk1NWZxQVR1R1RseVxuRUtCdGp0Qk5PUFhRaTBTQTRjVCtGTmZYQ2FlSEdrdFYxRE9vWFdkcDhOMGQ5dlBiem9rWEIvSjl1SWdWMnFJclxudGJlYnZJaUdaUkpid3IrVzVuOXQyUUQ3MnpOSXVZZkd2d0xSMm1CK0Z2ZGU5c2VHc2xOdUg2MklUOWx1UExBSVxuYVgxNE11WDlmOG83WUMxQmx5Z3Y0dnlBanRWME1VMWNXWHIxREZNVkJoL2pzRHlaYytGUW5RbFp2TkVYenQ4Y1xuTjB0VXFBRzVDWVEwTGlqOHVSUndmUEMzYzF6b3NPVUlialNrSG1oNk90WUJBOS9vd2xsenZNN2R6TXBLUVZUcVxuRzErNEdZTmRGcUtnQXNFQWtiQThFQzVDL2JwSXpqSng1T1dBakpsMlE2ZmlLbHJRemRFWGVBbEdLSm5YVmprL1xuR2d6K0VIM3RBZ01CQUFFQ2dmOHhTaWppTXJ3UEV1bGZ6U2Z6aFFrdE5YTEJhTlp3WjdtNTU5UzQ5SG1yMjQrY1xuaXhmSm93S2o2azlxUmRVNktIdVEzUlRIVHYvc3Q0VnVhWnNSWWlyOTJuSlJwNWFtZ2Q5dSt0SHJ3b3FJcTFFTVxuTnJ6SGRaV0FiTDJLcE9hTjk4NGN6WnRDbmRUdytzMTVQbzU3SXBya0ZwVTd2T0F4M2RFdVRDQlRBeFlEVDdtMFxuZ3JoT1FRUXVrdVhKc2l3OS9CUGs5Uk9obGFSQzY2cWFobTNjUjE0cFRpRFRTR1FrSnZvVmpUbXNxQWxKTFRuRVxuNFlrZjlxUEFuNFg5Y0c4ZStpOGpJYUVRMTB2NEZQUHVqdkxyd3NvdHJxeGo4c1ZFazRpWlNGMjlnRmtnTGF3Q1xuUVBLTTF5QnhnemFSRnJqSGJUNmxVbEJkMU5TeG9qTjdKYTE2UXNrQ2dZRUEwcWZEL1RyVld0SWlwemZ1SUdlVVxuK09wc2ZESGI4L1YxQWNiUWN6bUdycDgxWlhxaCtSOG1KcjBhOWEyZ3VkSU9QUFhGclFzN0VXOS9UcGkyK0xZblxuelJ4V1RmSDNaZlZKeWdhWXNXaUE2VDNjT3ovZHpuK3FFV0dnOFFOcWNyaUFPV2tkMkRoUWl3Ni9oZzRlNmFDNVxub25NRFR3WTVoREFJRlZUZEFYSU1hT2tDZ1lFQXVhOTE4dzlJMUV0a1l5UmRPaGdSRUk1aE5Ncmw5YUxOMFdBc1xubnBpTVZxVUx5NmYvd3hhSGRGUjlMYjZBR0VubUN5MzM3SldJWFZqM0h6WEk0RXRyWExhRTcyUEo3MklBVHl4U1xudm1RZzNIRHlBL1FMcGlUbUsxc2lHOXAyMlIrWHRNWFgrb1FNZmllSlZIajBFc3JmSnUwWkphV0ZsOFZobFBiWlxublY5Q0NtVUNnWUF0c3Brd3NQZWh1UjR0V2xPOUVkdGVXRFJxaU1KblhPTWlISWdSeHZQeG83WUlxcDdDbFVCSVxuZlJPQklrWlFxVUhQZFoySldYdFozKzhsRkxuMG9FZG9GbktlZkJRb09Scmx5YUtNTWRodFFLOHE1MEx0emdJTlxudlRrVnI2RUMvQVZNN3dHN2F4UUY1cEFqdTZKM0doZkxKdG9iNVlUS3FVVEhvOTVCdHdUOEtRS0JnUUM1SXIrSVxuWTRIcTRXeXJDUFBHMjM0UU10V3FyRzVSMWt3OTZSVXozOGQxRUVSTmZ5aWNHOWRjWG0wYzhlYUgwUTZEc1FhVFxucFpmNzhwc2FUQ2NIczByTmV0SGFXWFZhcnl5OXcrU1FIZ2RCbzM4NS85YXBoZnJUMlo2TmhPbWduRVpISUVleVxuYUh5SVArVkdDdjdYeWR4cTFGV1JXcEp6ZTRKSzQwQ2dEdjBxblFLQmdRQzFLeTh0OGZYWnFYVDhQNkNFRW1selxuR2E5S3k2Qm5rYXNmT1pQdHVmWTBwQzB0RDU2Ukx4MW9zSGQxb096elF6VlplaHBSTVdNYjM4WTduejhXMkd4ZVxudUc5cytrNTArM1JpNURXZXpIU1pvd0VNZzZGcXUrWEhiNGNYMFFacEpCRjNta2lKRDJISEQ3M3NuVzFNeFhydFxuM290eXJXTGZHYjRsUUhUcnE5eVFpZz09XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiaHNqLXNlcnZpY2VhY2NvdW50QGxpcXVpZC1wb2x5Z29uLTQwNDYwMC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMTQ4ODk3OTI2MDkyMDUzNjM4NjQiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2hzai1zZXJ2aWNlYWNjb3VudCU0MGxpcXVpZC1wb2x5Z29uLTQwNDYwMC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSIKfQo=
        project_id: aiosshsj
        export_default_credentials: true 

    # Get the GKE credentials so we can deploy to the cluster
    - uses: google-github-actions/get-gke-credentials@v2.1.0
      with:
        cluster_name: hsj-demo-cluster
        location: asia-northeast3-a
        credentials: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAibGlxdWlkLXBvbHlnb24tNDA0NjAwIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMmY0YjVkMDU4ZmM2MDJiODY1NWM2MzVmOWNmOThmMGQwYTQ5NWJmNCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZBSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS1l3Z2dTaUFnRUFBb0lCQVFDWXk1NWZxQVR1R1RseVxuRUtCdGp0Qk5PUFhRaTBTQTRjVCtGTmZYQ2FlSEdrdFYxRE9vWFdkcDhOMGQ5dlBiem9rWEIvSjl1SWdWMnFJclxudGJlYnZJaUdaUkpid3IrVzVuOXQyUUQ3MnpOSXVZZkd2d0xSMm1CK0Z2ZGU5c2VHc2xOdUg2MklUOWx1UExBSVxuYVgxNE11WDlmOG83WUMxQmx5Z3Y0dnlBanRWME1VMWNXWHIxREZNVkJoL2pzRHlaYytGUW5RbFp2TkVYenQ4Y1xuTjB0VXFBRzVDWVEwTGlqOHVSUndmUEMzYzF6b3NPVUlialNrSG1oNk90WUJBOS9vd2xsenZNN2R6TXBLUVZUcVxuRzErNEdZTmRGcUtnQXNFQWtiQThFQzVDL2JwSXpqSng1T1dBakpsMlE2ZmlLbHJRemRFWGVBbEdLSm5YVmprL1xuR2d6K0VIM3RBZ01CQUFFQ2dmOHhTaWppTXJ3UEV1bGZ6U2Z6aFFrdE5YTEJhTlp3WjdtNTU5UzQ5SG1yMjQrY1xuaXhmSm93S2o2azlxUmRVNktIdVEzUlRIVHYvc3Q0VnVhWnNSWWlyOTJuSlJwNWFtZ2Q5dSt0SHJ3b3FJcTFFTVxuTnJ6SGRaV0FiTDJLcE9hTjk4NGN6WnRDbmRUdytzMTVQbzU3SXBya0ZwVTd2T0F4M2RFdVRDQlRBeFlEVDdtMFxuZ3JoT1FRUXVrdVhKc2l3OS9CUGs5Uk9obGFSQzY2cWFobTNjUjE0cFRpRFRTR1FrSnZvVmpUbXNxQWxKTFRuRVxuNFlrZjlxUEFuNFg5Y0c4ZStpOGpJYUVRMTB2NEZQUHVqdkxyd3NvdHJxeGo4c1ZFazRpWlNGMjlnRmtnTGF3Q1xuUVBLTTF5QnhnemFSRnJqSGJUNmxVbEJkMU5TeG9qTjdKYTE2UXNrQ2dZRUEwcWZEL1RyVld0SWlwemZ1SUdlVVxuK09wc2ZESGI4L1YxQWNiUWN6bUdycDgxWlhxaCtSOG1KcjBhOWEyZ3VkSU9QUFhGclFzN0VXOS9UcGkyK0xZblxuelJ4V1RmSDNaZlZKeWdhWXNXaUE2VDNjT3ovZHpuK3FFV0dnOFFOcWNyaUFPV2tkMkRoUWl3Ni9oZzRlNmFDNVxub25NRFR3WTVoREFJRlZUZEFYSU1hT2tDZ1lFQXVhOTE4dzlJMUV0a1l5UmRPaGdSRUk1aE5Ncmw5YUxOMFdBc1xubnBpTVZxVUx5NmYvd3hhSGRGUjlMYjZBR0VubUN5MzM3SldJWFZqM0h6WEk0RXRyWExhRTcyUEo3MklBVHl4U1xudm1RZzNIRHlBL1FMcGlUbUsxc2lHOXAyMlIrWHRNWFgrb1FNZmllSlZIajBFc3JmSnUwWkphV0ZsOFZobFBiWlxublY5Q0NtVUNnWUF0c3Brd3NQZWh1UjR0V2xPOUVkdGVXRFJxaU1KblhPTWlISWdSeHZQeG83WUlxcDdDbFVCSVxuZlJPQklrWlFxVUhQZFoySldYdFozKzhsRkxuMG9FZG9GbktlZkJRb09Scmx5YUtNTWRodFFLOHE1MEx0emdJTlxudlRrVnI2RUMvQVZNN3dHN2F4UUY1cEFqdTZKM0doZkxKdG9iNVlUS3FVVEhvOTVCdHdUOEtRS0JnUUM1SXIrSVxuWTRIcTRXeXJDUFBHMjM0UU10V3FyRzVSMWt3OTZSVXozOGQxRUVSTmZ5aWNHOWRjWG0wYzhlYUgwUTZEc1FhVFxucFpmNzhwc2FUQ2NIczByTmV0SGFXWFZhcnl5OXcrU1FIZ2RCbzM4NS85YXBoZnJUMlo2TmhPbWduRVpISUVleVxuYUh5SVArVkdDdjdYeWR4cTFGV1JXcEp6ZTRKSzQwQ2dEdjBxblFLQmdRQzFLeTh0OGZYWnFYVDhQNkNFRW1selxuR2E5S3k2Qm5rYXNmT1pQdHVmWTBwQzB0RDU2Ukx4MW9zSGQxb096elF6VlplaHBSTVdNYjM4WTduejhXMkd4ZVxudUc5cytrNTArM1JpNURXZXpIU1pvd0VNZzZGcXUrWEhiNGNYMFFacEpCRjNta2lKRDJISEQ3M3NuVzFNeFhydFxuM290eXJXTGZHYjRsUUhUcnE5eVFpZz09XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiaHNqLXNlcnZpY2VhY2NvdW50QGxpcXVpZC1wb2x5Z29uLTQwNDYwMC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMTQ4ODk3OTI2MDkyMDUzNjM4NjQiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2hzai1zZXJ2aWNlYWNjb3VudCU0MGxpcXVpZC1wb2x5Z29uLTQwNDYwMC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSIKfQo=

    # Deploy the new Docker image to the GKE cluster
    - name: Deploy
      working-directory: ch9_release/src/Tailwind.Traders.Web
      run: |-
        envsubst < Service.yml | kubectl apply -f -
        envsubst < Deployment.yml | kubectl apply -f -
